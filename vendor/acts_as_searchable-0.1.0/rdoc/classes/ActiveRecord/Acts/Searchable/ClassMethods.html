<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: ActiveRecord::Acts::Searchable::ClassMethods</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">ActiveRecord::Acts::Searchable::ClassMethods</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../../files/lib/acts_as_searchable_rb.html">
                lib/acts_as_searchable.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000068">acts_as_searchable</a>&nbsp;&nbsp;
      <a href="#M000070">clear_index!</a>&nbsp;&nbsp;
      <a href="#M000069">fulltext_search</a>&nbsp;&nbsp;
      <a href="#M000071">reindex!</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">


    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">VALID_FULLTEXT_OPTIONS</td>
          <td>=</td>
          <td class="context-item-value">[:limit, :offset, :order, :attributes, :raw_matches, :find]</td>
        </tr>
        </table>
      </div>
    </div>



      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000068" class="method-detail">
        <a name="M000068"></a>

        <div class="method-heading">
          <a href="#M000068" class="method-signature">
          <span class="method-name">acts_as_searchable</span><span class="method-args">(options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <h2>Configuration options</h2>
<ul>
<li><tt>searchable_fields</tt> - Fields to provide searching and indexing for
(default: &#8216;body&#8217;)

</li>
<li><tt>attributes</tt> - Additional attributes to store in Hyper Estraier with
the appropriate method supplying the value

</li>
<li><tt>if_changed</tt> - Extra list of attributes to add to the list of
attributes that trigger an index update when changed

</li>
</ul>
<p>
Examples:
</p>
<pre>
  acts_as_searchable :attributes =&gt; { :title =&gt; nil, :blog =&gt; :blog_title }, :searchable_fields =&gt; [ :title, :body ]
</pre>
<p>
This would store the return value of the <tt>title</tt> method in the
<tt>title</tt> attribute and the return value of the <tt>blog_title</tt>
method in the <tt>blog</tt> attribute. The contents of the <tt>title</tt>
and <tt>body</tt> columns would end up being indexed for searching.
</p>
<h2>Attribute naming</h2>
<p>
Attributes that match the reserved names of the Hyper Estraier system
attributes are mapped automatically. This is something to keep in mind for
custom ordering options or additional query constraints in <tt><a
href="ClassMethods.html#M000069">fulltext_search</a></tt> For a list of
these attributes see <tt>EstraierPure::SYSTEM_ATTRIBUTES</tt> or visit:
</p>
<pre>
  http://hyperestraier.sourceforge.net/uguide-en.html#attributes
</pre>
<p>
From the example above:
</p>
<pre>
  Model.fulltext_search('query', :order =&gt; '@title STRA')               # Returns results ordered by title in ascending order
  Model.fulltext_search('query', :attributes =&gt; 'blog STREQ poocs.net') # Returns results with a blog attribute of 'poocs.net'
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000068-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000068-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_searchable.rb, line 113</span>
113:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">acts_as_searchable</span>(<span class="ruby-identifier">options</span> = {})
114:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">included_modules</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Acts</span><span class="ruby-operator">::</span><span class="ruby-constant">Searchable</span><span class="ruby-operator">::</span><span class="ruby-constant">ActMethods</span>)
115: 
116:           <span class="ruby-identifier">send</span> <span class="ruby-identifier">:include</span>, <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Acts</span><span class="ruby-operator">::</span><span class="ruby-constant">Searchable</span><span class="ruby-operator">::</span><span class="ruby-constant">ActMethods</span>
117:           
118:           <span class="ruby-identifier">cattr_accessor</span> <span class="ruby-identifier">:searchable_fields</span>, <span class="ruby-identifier">:attributes_to_store</span>, <span class="ruby-identifier">:if_changed</span>, <span class="ruby-identifier">:estraier_connection</span>, <span class="ruby-identifier">:estraier_node</span>,
119:             <span class="ruby-identifier">:estraier_host</span>, <span class="ruby-identifier">:estraier_port</span>, <span class="ruby-identifier">:estraier_user</span>, <span class="ruby-identifier">:estraier_password</span>
120: 
121:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">estraier_node</span>        = <span class="ruby-identifier">estraier_config</span>[<span class="ruby-value str">'node'</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">RAILS_ENV</span>
122:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">estraier_host</span>        = <span class="ruby-identifier">estraier_config</span>[<span class="ruby-value str">'host'</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">'localhost'</span>
123:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">estraier_port</span>        = <span class="ruby-identifier">estraier_config</span>[<span class="ruby-value str">'port'</span>] <span class="ruby-operator">||</span> <span class="ruby-value">1978</span>
124:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">estraier_user</span>        = <span class="ruby-identifier">estraier_config</span>[<span class="ruby-value str">'user'</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">'admin'</span>
125:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">estraier_password</span>    = <span class="ruby-identifier">estraier_config</span>[<span class="ruby-value str">'password'</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">'admin'</span>
126:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">searchable_fields</span>    = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:searchable_fields</span>] <span class="ruby-operator">||</span> [ <span class="ruby-identifier">:body</span> ]
127:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">attributes_to_store</span>  = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:attributes</span>] <span class="ruby-operator">||</span> {}
128:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">if_changed</span>           = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:if_changed</span>] <span class="ruby-operator">||</span> []
129:           
130:           <span class="ruby-identifier">send</span> <span class="ruby-identifier">:attr_accessor</span>, <span class="ruby-identifier">:changed_attributes</span>
131: 
132:           <span class="ruby-identifier">class_eval</span> <span class="ruby-keyword kw">do</span>
133:             <span class="ruby-identifier">after_update</span>  <span class="ruby-identifier">:update_index</span>
134:             <span class="ruby-identifier">after_create</span>  <span class="ruby-identifier">:add_to_index</span>
135:             <span class="ruby-identifier">after_destroy</span> <span class="ruby-identifier">:remove_from_index</span>
136:             <span class="ruby-identifier">after_save</span>    <span class="ruby-identifier">:clear_changed_attributes</span>
137: 
138:             (<span class="ruby-identifier">if_changed</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">searchable_fields</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">attributes_to_store</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">attribute</span>, <span class="ruby-identifier">method</span><span class="ruby-operator">|</span> <span class="ruby-identifier">method</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">attribute</span> }).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">attr_name</span><span class="ruby-operator">|</span>
139:               <span class="ruby-identifier">define_method</span>(<span class="ruby-node">&quot;#{attr_name}=&quot;</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
140:                 <span class="ruby-identifier">write_changed_attribute</span> <span class="ruby-identifier">attr_name</span>, <span class="ruby-identifier">value</span>
141:               <span class="ruby-keyword kw">end</span>
142:             <span class="ruby-keyword kw">end</span>
143: 
144:             <span class="ruby-identifier">connect_estraier</span>
145:           <span class="ruby-keyword kw">end</span>
146:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000070" class="method-detail">
        <a name="M000070"></a>

        <div class="method-heading">
          <a href="#M000070" class="method-signature">
          <span class="method-name">clear_index!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Clear all entries from index
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000070-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000070-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_searchable.rb, line 209</span>
209:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">clear_index!</span>
210:           <span class="ruby-identifier">estraier_index</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span> <span class="ruby-identifier">estraier_connection</span>.<span class="ruby-identifier">out_doc</span>(<span class="ruby-identifier">d</span>.<span class="ruby-identifier">attr</span>(<span class="ruby-value str">'@id'</span>)) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">nil?</span> }
211:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000069" class="method-detail">
        <a name="M000069"></a>

        <div class="method-heading">
          <a href="#M000069" class="method-signature">
          <span class="method-name">fulltext_search</span><span class="method-args">(query = &quot;&quot;, options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Perform a fulltext search against the Hyper Estraier index.
</p>
<p>
Options taken:
</p>
<ul>
<li><tt>limit</tt> - Maximum number of records to retrieve (default:
<tt>100</tt>)

</li>
<li><tt>offset</tt> - Number of records to skip (default: <tt>0</tt>)

</li>
<li><tt>order</tt> - Hyper Estraier expression to sort the results (example:
<tt>@title STRA</tt>, default: ordering by score)

</li>
<li><tt>attributes</tt> - String to append to Hyper Estraier search query

</li>
<li><tt>raw_matches</tt> - Returns raw Hyper Estraier documents instead of
instantiated AR objects

</li>
<li><tt>find</tt> - Options to pass on to the <tt>ActiveRecord::Base#find</tt>
call

</li>
</ul>
<p>
Examples:
</p>
<pre>
  Article.fulltext_search(&quot;biscuits AND gravy&quot;)
  Article.fulltext_search(&quot;biscuits AND gravy&quot;, :limit =&gt; 15, :offset =&gt; 14)
  Article.fulltext_search(&quot;biscuits AND gravy&quot;, :attributes =&gt; &quot;tag STRINC food&quot;)
  Article.fulltext_search(&quot;biscuits AND gravy&quot;, :attributes =&gt; [&quot;tag STRINC food&quot;, &quot;@title STRBW Biscuit&quot;])
  Article.fulltext_search(&quot;biscuits AND gravy&quot;, :order =&gt; &quot;@title STRA&quot;)
  Article.fulltext_search(&quot;biscuits AND gravy&quot;, :raw_matches =&gt; true)
  Article.fulltext_search(&quot;biscuits AND gravy&quot;, :find =&gt; { :order =&gt; :title, :include =&gt; :comments })
</pre>
<p>
Consult the Hyper Estraier documentation on proper query syntax:
</p>
<pre>
  http://hyperestraier.sourceforge.net/uguide-en.html#searchcond
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000069-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000069-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_searchable.rb, line 172</span>
172:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fulltext_search</span>(<span class="ruby-identifier">query</span> = <span class="ruby-value str">&quot;&quot;</span>, <span class="ruby-identifier">options</span> = {})
173:           <span class="ruby-identifier">options</span>.<span class="ruby-identifier">reverse_merge!</span>(<span class="ruby-identifier">:limit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">100</span>, <span class="ruby-identifier">:offset</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>)
174:           <span class="ruby-identifier">options</span>.<span class="ruby-identifier">assert_valid_keys</span>(<span class="ruby-constant">VALID_FULLTEXT_OPTIONS</span>)
175: 
176:           <span class="ruby-identifier">find_options</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:find</span>] <span class="ruby-operator">||</span> {}
177:           [ <span class="ruby-identifier">:limit</span>, <span class="ruby-identifier">:offset</span> ].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">find_options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">k</span>) } <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">find_options</span>.<span class="ruby-identifier">blank?</span>
178: 
179:           <span class="ruby-identifier">cond</span> = <span class="ruby-constant">EstraierPure</span><span class="ruby-operator">::</span><span class="ruby-constant">Condition</span>.<span class="ruby-identifier">new</span>
180:           <span class="ruby-identifier">cond</span>.<span class="ruby-identifier">set_phrase</span> <span class="ruby-identifier">query</span>
181:           <span class="ruby-identifier">cond</span>.<span class="ruby-identifier">add_attr</span>(<span class="ruby-node">&quot;type STREQ #{self.to_s}&quot;</span>)
182:           [<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:attributes</span>]].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">reject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">blank?</span> }.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">attr</span><span class="ruby-operator">|</span>
183:             <span class="ruby-identifier">cond</span>.<span class="ruby-identifier">add_attr</span> <span class="ruby-identifier">attr</span>
184:           <span class="ruby-keyword kw">end</span>
185:           <span class="ruby-identifier">cond</span>.<span class="ruby-identifier">set_max</span>   <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:limit</span>]
186:           <span class="ruby-identifier">cond</span>.<span class="ruby-identifier">set_skip</span>  <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:offset</span>]
187:           <span class="ruby-identifier">cond</span>.<span class="ruby-identifier">set_order</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:order</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:order</span>]
188: 
189:           <span class="ruby-identifier">matches</span> = <span class="ruby-keyword kw">nil</span>
190:           <span class="ruby-identifier">seconds</span> = <span class="ruby-constant">Benchmark</span>.<span class="ruby-identifier">realtime</span> <span class="ruby-keyword kw">do</span>
191:             <span class="ruby-identifier">result</span> = <span class="ruby-identifier">estraier_connection</span>.<span class="ruby-identifier">search</span>(<span class="ruby-identifier">cond</span>, <span class="ruby-value">1</span>);
192:             <span class="ruby-keyword kw">return</span> [] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">result</span>
193:             
194:             <span class="ruby-identifier">matches</span> = <span class="ruby-identifier">get_docs_from</span>(<span class="ruby-identifier">result</span>)
195:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">matches</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:raw_matches</span>]
196:           <span class="ruby-keyword kw">end</span>
197: 
198:           <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span>(
199:             <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">:format_log_entry</span>, 
200:               <span class="ruby-node">&quot;#{self.to_s} seach for '#{query}' (#{sprintf(&quot;%f&quot;, seconds)})&quot;</span>,
201:               <span class="ruby-node">&quot;Condition: #{cond.to_s}&quot;</span>
202:             )
203:           )
204:             
205:           <span class="ruby-identifier">matches</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span>[] <span class="ruby-operator">:</span> <span class="ruby-identifier">find</span>(<span class="ruby-identifier">matches</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">attr</span>(<span class="ruby-value str">'db_id'</span>) }, <span class="ruby-identifier">find_options</span>)
206:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000071" class="method-detail">
        <a name="M000071"></a>

        <div class="method-heading">
          <a href="#M000071" class="method-signature">
          <span class="method-name">reindex!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Peform a full re-index of the model data for this model
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000071-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000071-source">
<pre>
     <span class="ruby-comment cmt"># File lib/acts_as_searchable.rb, line 214</span>
214:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reindex!</span>
215:           <span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">update_index</span>(<span class="ruby-keyword kw">true</span>) }
216:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>